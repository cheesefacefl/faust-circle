<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Doctor Faust â€” Summoning Circle</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background-color: #0d0d0d;
      color: #f1e9d9;
      font-family: 'Georgia', serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
      text-align: center;
    }
    h1 {
      font-size: 2.5rem;
    }
    button {
      padding: 1rem 2rem;
      font-size: 1.2rem;
      background-color: #a86;
      border: none;
      color: white;
      border-radius: 8px;
      cursor: pointer;
    }
    button:hover {
      background-color: #c98;
    }
    .log {
      margin-top: 2rem;
      padding: 1rem;
      max-width: 80%;
      height: 200px;
      overflow-y: auto;
      border: 1px solid #333;
      background-color: rgba(0,0,0,0.3);
    }
    audio {
      display: block;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <h1>Doctor Johann Georg Faust</h1>
  <button onclick="summon()">Summon</button>
  <div class="log" id="log">
    <p><em>The circle waits. What form shall he take?</em></p>
  </div>
  <audio id="ambientAudio" autoplay loop></audio>
  <script>
    const moods = [
      { name: 'dream', audio: 'https://cdn.pixabay.com/download/audio/2023/05/29/audio_f44d89f817.mp3', prompt: 'You are Faust summoned through dream. Speak in riddles, softly, as if not fully awake.' },
      { name: 'sea', audio: 'https://cdn.pixabay.com/download/audio/2023/05/16/audio_1e1ce0c2fa.mp3', prompt: 'You are Faust, drawn to the sea. Your words echo like waves. Speak with deep thought and wonder.' },
      { name: 'grief', audio: 'https://cdn.pixabay.com/download/audio/2022/03/18/audio_9376ccfe52.mp3', prompt: 'You are Faust, weary from sorrow. Speak as if you have lived long, and lost much.' },
      { name: 'joy', audio: 'https://cdn.pixabay.com/download/audio/2022/03/25/audio_cab3a1d808.mp3', prompt: 'You are Faust, summoned in a rare moment of joy. Speak warmly, with human curiosity.' },
      { name: 'ritual', audio: '', prompt: 'You are Faust, summoned in ritual silence. Let your words be few, sacred, and deliberate.' }
    ];

    function pickMoodWeighted() {
      const weights = [30, 20, 25, 15, 10]; // grief, dream, sea, joy, ritual
      const sum = weights.reduce((a, b) => a + b, 0);
      let r = Math.random() * sum;
      for (let i = 0; i < weights.length; i++) {
        if (r < weights[i]) return moods[i];
        r -= weights[i];
      }
      return moods[0];
    }

    async function summon() {
      const mood = pickMoodWeighted();
      const log = document.getElementById('log');
      const ambient = document.getElementById('ambientAudio');

      // Play matching ambient
      ambient.src = mood.audio;
      ambient.volume = mood.name === 'ritual' ? 0 : 0.4;
      ambient.play();

      log.innerHTML += `<p><em>The mood is <strong>${mood.name.toUpperCase()}</strong>.</em></p>`;

      const response = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer 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"
        },
        body: JSON.stringify({
          model: "gpt-4",
          messages: [
            {
              role: "system",
              content: mood.prompt + " Sometimes you speak first. Sometimes you observe. Occasionally, you ask a question. Never break character."
            },
            {
              role: "user",
              content: "You arrive. What do you do?"
            }
          ]
        })
      });

      const data = await response.json();
      const faustMessage = data.choices[0].message.content;
      log.innerHTML += `<p><strong>Faust:</strong> ${faustMessage}</p>`;

      const ttsResponse = await fetch("https://api.elevenlabs.io/v1/text-to-speech/HPtuHnug7xtKQV3ZiQTA", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "xi-api-key": "sk_2ef5ba1bdea776969754600165af2e98b7e86316953f85a3"
        },
        body: JSON.stringify({
          text: faustMessage,
          model_id: "eleven_multilingual_v2",
          voice_settings: {
            stability: 0.2,
            similarity_boost: 0.7
          }
        })
      });

      const ttsBlob = await ttsResponse.blob();
      const audioUrl = URL.createObjectURL(ttsBlob);
      const audio = new Audio(audioUrl);
      audio.controls = true;
      audio.autoplay = true;
      document.body.appendChild(audio);
    }
  </script>
</body>
</html>
